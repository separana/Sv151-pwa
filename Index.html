<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SV151 – 207 Kaarten Tracker (PWA)</title>
  <meta name="theme-color" content="#0b0d10" />
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.png">
  <link rel="apple-touch-icon" href="icon.png">
  <style>
    :root{
      --bg:#0b0d10;--text:#eaf1fa;--muted:#9ab0c7;--border:#1e2631;
      --brand:#67b7ff;--ok:#3ad7a4;--warn:#ffcc66;
    }
    *{box-sizing:border-box} body{margin:0;background:radial-gradient(1000px 700px at 70% -20%, rgba(103,183,255,.14), transparent 50%),var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(11,13,16,.95),rgba(11,13,16,.75));backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center}.logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(180deg,#1d2833,#141a22);border:1px solid var(--border);display:grid;place-items:center}
    .logo i{width:16px;height:16px;border-radius:50%;background:#67b7ff;box-shadow:0 0 0 6px rgba(103,183,255,.15)}
    h1{font-size:18px;margin:0}
    .statbar{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:12px;margin-top:12px}
    .stat{background:linear-gradient(180deg,#141a22,#0f141a);border:1px solid var(--border);border-radius:14px;padding:14px}
    .stat .label{color:var(--muted);font-size:13px}.stat .value{font-weight:700;font-size:20px}
    .progress-outer{height:10px;border-radius:999px;background:#16202a;border:1px solid var(--border);overflow:hidden;margin-top:8px}
    .progress-inner{height:100%;width:0%;background:linear-gradient(90deg,var(--ok),var(--brand));transition:width .2s ease}
    .panel{margin-top:14px;border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,#12171e,#0f141a)}
    .panel .inner{padding:14px}
    input[type=search],select{background:#121821;border:1px solid var(--border);color:var(--text);border-radius:12px;padding:12px 14px;outline:none}
    input[type=search]:focus,select:focus{border-color:#63c2ff;box-shadow:0 0 0 4px rgba(99,194,255,.15)}
    .btn{border:1px solid var(--border);background:linear-gradient(180deg,#1b232c,#141a22);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{border-color:rgba(103,183,255,.5);background:linear-gradient(180deg,#1d2a34,#17222b)}
    .grid{display:grid;gap:14px;padding:16px;grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
    .card{position:relative;border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#0f141a}
    .card img{width:100%;display:block;aspect-ratio:3/4;object-fit:cover;background:#0b1016}
    .meta{padding:10px 12px;display:grid;gap:6px}.name{font-weight:600}
    .sub{color:var(--muted);font-size:12px;display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:11px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#151b23;color:#c9d7e6}
    .own-toggle{position:absolute;top:10px;right:10px;width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:rgba(0,0,0,.35);display:grid;place-items:center;cursor:pointer}
    .own-toggle.owned{background:linear-gradient(180deg,rgba(58,215,164,.85),rgba(58,215,164,.6));border-color:rgba(58,215,164,.9)}
    .footer{color:var(--muted);text-align:center;padding:40px 0}
    @media(max-width:480px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media print{header,.panel,.btn,.footer{display:none!important}body{background:#fff;color:#000}.grid{grid-template-columns:repeat(3,1fr);gap:10px}.card{box-shadow:none;border:1px solid #ddd}}
    dialog#viewer{border:none;border-radius:16px;padding:0;width:min(900px,95vw);background:#0f141a;color:#eaf1fa}
    .viewer-body{display:grid;gap:0;grid-template-columns:1fr 1fr}
    .viewer-img{padding:14px;display:grid;place-items:center;background:#0a0f14}.viewer-img img{max-width:100%;height:auto;display:block}
    .viewer-meta{padding:16px;display:grid;gap:12px}
    .viewer-actions{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .nav-btn{border:1px solid var(--border);background:#121821;color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
    @media(max-width:780px){.viewer-body{grid-template-columns:1fr}}
    .status{color:var(--muted);font-size:12px;margin-left:8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div class="logo"><i></i></div>
          <div>
            <h1>Pokémon TCG – Scarlet &amp; Violet 151</h1>
            <div style="font-size:12px;color:var(--muted)">207 unieke kaarten • PWA • offline na cachen</div>
          </div>
        </div>
        <div style="margin-left:auto" class="row">
          <button id="exportBtn" class="btn">Exporteer</button>
          <label class="btn">Importeer<input id="importFile" type="file" accept="application/json" style="display:none"></label>
          <button id="reloadBtn" class="btn">Herlaad kaarten</button>
          <button id="prefetchBtn" class="btn primary">Offline voorbereiden</button>
          <button id="printBtn" class="btn">Print</button>
        </div>
      </div>
      <div class="statbar">
        <div class="stat">
          <div class="label">Collection Progress</div>
          <div class="value"><span id="ownedCount">0</span>/<span id="totalCount">207</span> <span id="status" class="status"></span></div>
          <div class="progress-outer"><div id="progress" class="progress-inner"></div></div>
        </div>
        <div class="stat">
          <div class="label">Cards Collected</div>
          <div class="value" style="color:var(--ok)"><span id="ownedOnly">0</span></div>
        </div>
        <div class="stat">
          <div class="label">Cards Needed</div>
          <div class="value" style="color:var(--warn)"><span id="missingOnly">207</span></div>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="inner">
        <div class="row">
          <input id="search" type="search" placeholder="Zoek op naam of #…" style="flex:1">
          <select id="typeFilter"><option value="">Alle types</option></select>
          <select id="rarityFilter"><option value="">Alle rarities</option></select>
          <select id="ownedFilter">
            <option value="">Alle kaarten</option>
            <option value="owned">Heb ik</option>
            <option value="missing">Mis ik</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <main class="panel" style="margin-left:auto;margin-right:auto;max-width:1100px">
    <div id="grid" class="grid"></div>
  </main>

  <div class="footer">Tip: druk “Offline voorbereiden” om **alle 207 images** (small + large) te cachen. Daarna werkt alles zonder internet (HTTPS/PWA vereist).</div>

  <!-- Popup Viewer -->
  <dialog id="viewer">
    <div class="viewer-body">
      <div class="viewer-img"><img id="viewImg" alt=""></div>
      <div class="viewer-meta">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="name" id="viewName"></div>
            <div class="sub"><span class="badge" id="viewNum"></span> <span class="badge" id="viewRarity"></span> <span id="viewTypes"></span></div>
          </div>
          <button id="closeViewer" class="nav-btn">Sluiten</button>
        </div>
        <div class="viewer-actions">
          <button id="prevBtn" class="nav-btn">← Vorige</button>
          <input id="jumpSearch" type="search" placeholder="Zoek kaart…" style="flex:1;background:#121821;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px 10px">
          <button id="nextBtn" class="nav-btn">Volgende →</button>
        </div>
      </div>
    </div>
  </dialog>

  <script>
    // Service worker voor PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js');
      });
    }

    const STORAGE_KEY = 'sv151-pwa-tracker';
    let state = loadState();
    let cards = [];
    let filtered = [];
    let currentIndex = -1;

    function loadState(){
      try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : {owned:{}, qty:{}, notes:{}}; }
      catch(e){ return {owned:{}, qty:{}, notes:{}}; }
    }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));

    const grid = qs('#grid');
    const typeSel = qs('#typeFilter');
    const rarSel = qs('#rarityFilter');
    const ownedSel = qs('#ownedFilter');
    const search = qs('#search');
    const statusEl = qs('#status');

    // Export/Import/Print
    qs('#exportBtn').addEventListener('click', () => {
      const payload = JSON.stringify(state, null, 2);
      const blob = new Blob([payload], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'sv151-collectie.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });
    qs('#importFile').addEventListener('change', ev => {
      const file = ev.target.files?.[0]; if(!file) return;
      const r = new FileReader();
      r.onload = () => {
        try{ state = JSON.parse(String(r.result)); saveState(); render(); updateStats(); }
        catch(e){ alert('Import mislukt: ' + e.message); }
      }; r.readAsText(file);
    });
    qs('#printBtn').addEventListener('click', () => window.print());

    // Filters
    search.addEventListener('input', () => render());
    typeSel.addEventListener('change', () => render());
    rarSel.addEventListener('change', () => render());
    ownedSel.addEventListener('change', () => render());
    qs('#reloadBtn').addEventListener('click', fetchAll);

    function matchFilters(c){
      const q = search.value.trim().toLowerCase();
      if (q) {
        const text = (c.name + ' ' + c.number).toLowerCase();
        if (!text.includes(q)) return false;
      }
      if (typeSel.value && !(c.types||[]).includes(typeSel.value)) return false;
      if (rarSel.value && (c.rarity||'') !== rarSel.value) return false;
      const owned = !!state.owned[c.id];
      if (ownedSel.value === 'owned' && !owned) return false;
      if (ownedSel.value === 'missing' && owned) return false;
      return true;
    }

    function render(){
      filtered = cards.filter(matchFilters);
      grid.innerHTML = '';
      filtered.forEach((c, idx) => {
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <div class="own-toggle ${state.owned[c.id] ? 'owned':''}" data-id="${c.id}" title="${state.owned[c.id] ? 'In collectie' : 'Klik om te markeren'}">✓</div>
          <img loading="lazy" src="${c.images?.small || ''}" alt="${c.name}" data-large="${c.images?.large || ''}" data-idx="${idx}">
          <div class="meta">
            <div class="name">${c.name}</div>
            <div class="sub">
              <span class="badge">#${c.number}</span>
              ${c.rarity ? `<span class="badge">${c.rarity}</span>`:''}
              ${(c.types||[]).map(t=>`<span class="badge">${t}</span>`).join('')}
            </div>
          </div>
        `;
        grid.appendChild(el);
      });
      // Events
      qsa('.own-toggle').forEach(btn => btn.addEventListener('click', (e) => {
        const id = btn.getAttribute('data-id');
        state.owned[id] = !state.owned[id];
        saveState();
        btn.classList.toggle('owned');
        updateStats();
        e.stopPropagation();
      }));
      qsa('.card img').forEach(img => img.addEventListener('click', () => openViewer(Number(img.dataset.idx)) ));
      updateStats();
      statusEl.textContent = `Geladen: ${cards.length} kaarten`;
    }

    function updateStats(){
      const total = cards.length || 207;
      const owned = cards.reduce((acc,c)=>acc + (state.owned[c.id] ? 1 : 0), 0);
      qs('#ownedCount').textContent = owned;
      qs('#totalCount').textContent = total;
      qs('#ownedOnly').textContent = owned;
      qs('#missingOnly').textContent = Math.max(0, total - owned);
      const pct = total ? Math.round(owned/total*100) : 0;
      qs('#progress').style.width = pct + '%';
    }

    // Popup viewer
    const viewer = qs('#viewer');
    const viewImg = qs('#viewImg');
    const viewName = qs('#viewName');
    const viewNum = qs('#viewNum');
    const viewRarity = qs('#viewRarity');
    const viewTypes = qs('#viewTypes');
    const closeViewer = qs('#closeViewer');
    const prevBtn = qs('#prevBtn');
    const nextBtn = qs('#nextBtn');
    const jumpSearch = qs('#jumpSearch');

    function openViewer(idx){
      currentIndex = idx;
      const c = filtered[currentIndex];
      if (!c) return;
      viewImg.src = c.images?.large || c.images?.small || '';
      viewName.textContent = c.name;
      viewNum.textContent = '#' + c.number;
      viewRarity.textContent = c.rarity || '';
      viewTypes.innerHTML = (c.types||[]).map(t=>`<span class="badge">${t}</span>`).join('');
      viewer.showModal();
    }
    function closeV(){ viewer.close(); }
    function prev(){ if (currentIndex > 0) openViewer(currentIndex - 1); }
    function next(){ if (currentIndex < filtered.length - 1) openViewer(currentIndex + 1); }
    function jump(){ 
      const q = jumpSearch.value.trim().toLowerCase();
      const idx = filtered.findIndex(c => (c.name + ' ' + c.number).toLowerCase().includes(q));
      if (idx >= 0) openViewer(idx);
    }
    closeViewer.addEventListener('click', closeV);
    prevBtn.addEventListener('click', prev);
    nextBtn.addEventListener('click', next);
    jumpSearch.addEventListener('keydown', (e) => { if (e.key === 'Enter') jump(); });

    // Fetch cards via API (harde set-id)
    async function fetchAll(){
      try{
        statusEl.textContent = 'Laden…';
        const url = new URL('https://api.pokemontcg.io/v2/cards');
        url.searchParams.set('pageSize','250');
        url.searchParams.set('q','set.id:"sv3pt5"');
        const res = await fetch(url.toString());
        if (!res.ok) throw new Error('API status ' + res.status);
        const data = await res.json();
        cards = (data.data || []).sort((a,b)=> Number(a.number.replace(/\D/g,'')) - Number(b.number.replace(/\D/g,'')) );
        // Filters invullen
        const types = Array.from(new Set(cards.flatMap(c => c.types||[]))).sort();
        typeSel.innerHTML = '<option value="">Alle types</option>' + types.map(t=>`<option value="${t}">${t}</option>`).join('');
        const rarities = Array.from(new Set(cards.map(c => c.rarity).filter(Boolean))).sort();
        rarSel.innerHTML = '<option value="">Alle rarities</option>' + rarities.map(r=>`<option value="${r}">${r}</option>`).join('');
        render();
      }catch(err){
        statusEl.textContent = 'Fout bij laden';
        alert('Kon kaarten niet laden. Test deze link in een nieuw tabblad:\nhttps://api.pokemontcg.io/v2/cards?q=set.id:%22sv3pt5%22&pageSize=250\n\n' + err.message);
      }
    }

    // Prefetch voor offline
    async function prefetchAll(){
      if (!navigator.serviceWorker?.controller) {
        alert('Service worker nog niet actief. Herlaad de pagina en probeer opnieuw.');
        return;
      }
      if (!cards.length) { await fetchAll(); }
      const smalls = cards.map(c => c.images?.small).filter(Boolean);
      const larges = cards.map(c => c.images?.large).filter(Boolean);
      const all = [...smalls, ...larges];
      const channel = new MessageChannel();
      channel.port1.onmessage = (event) => {
        if (event.data?.ok) alert('Alle kaartafbeeldingen zijn gecachet voor offline gebruik!');
      };
      navigator.serviceWorker.controller.postMessage({ type:'PREFETCH', urls: all }, [channel.port2]);
    }

    qs('#prefetchBtn').addEventListener('click', prefetchAll);

    fetchAll();
  </script>
</body>
</html>
